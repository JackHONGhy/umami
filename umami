#!/usr/bin/env bash
# Umami Docker ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆå¯ wget ä¸‹è½½ï¼‰
# ä¸å®‰è£… dockerï¼Œæœ¬æœºéœ€å·²å®‰è£… docker & docker compose
# ä½¿ç”¨æ–¹å¼ï¼šsudo bash umami.sh

set -euo pipefail

UMAMI_DIR="/opt/umami-docker"
COMPOSE_FILE="${UMAMI_DIR}/docker-compose.yml"
CONFIG_FILE="/etc/umami-docker.conf"
UMAMI_PORT=3000

###############################################
# å·¥å…·å‡½æ•°
###############################################
require_root() {
  if [[ "$EUID" -ne 0 ]]; then
    echo "âŒ è¯·ä½¿ç”¨ root æˆ– sudo è¿è¡Œè„šæœ¬"
    exit 1
  fi
}

pause() {
  echo
  read -rp "ğŸ‘‰ æŒ‰å›è½¦ç»§ç»­..." _
}

print_header() {
  clear
  echo "===================================================="
  echo "           Umami Docker ä¸€é”®ç®¡ç†è„šæœ¬"
  echo "===================================================="
  echo
}

get_ip() {
  ip=$(hostname -I | awk '{print $1}')
  [[ -z "$ip" ]] && ip="localhost"
  echo "$ip"
}

###############################################
# é…ç½®åŠ è½½/ç”Ÿæˆ
###############################################
load_or_create_config() {
  if [[ -f "$CONFIG_FILE" ]]; then
    . "$CONFIG_FILE"
  else
    DB_PASSWORD=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 20)
    cat > "$CONFIG_FILE" <<EOF
DB_PASSWORD="$DB_PASSWORD"
UMAMI_PORT="$UMAMI_PORT"
EOF
    chmod 600 "$CONFIG_FILE"
  fi
}

###############################################
# ç”Ÿæˆ docker-compose.yml
###############################################
generate_compose_file() {
mkdir -p "$UMAMI_DIR"

cat > "$COMPOSE_FILE" <<EOF
version: '3.9'

services:
  umami-db:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_DB: umami
      POSTGRES_USER: umami
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - umami-db-data:/var/lib/postgresql/data

  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    restart: always
    ports:
      - "${UMAMI_PORT}:3000"
    depends_on:
      - umami-db
    environment:
      DATABASE_URL: postgresql://umami:${DB_PASSWORD}@umami-db:5432/umami

volumes:
  umami-db-data:
EOF
}


###############################################
# å®‰è£…
###############################################
install_umami() {
  print_header
  echo "ğŸ“¦ æ­£åœ¨éƒ¨ç½² Umamiï¼ˆDocker æ¨¡å¼ï¼‰..."
  echo

  generate_compose_file

  cd "$UMAMI_DIR"
  docker compose pull
  docker compose up -d

  clear
  echo "ğŸ‰ å®‰è£…å®Œæˆï¼"
  echo

  ip=$(get_ip)
  echo "ğŸ“ è®¿é—®åœ°å€ï¼š http://${ip}:${UMAMI_PORT}"
  echo "ğŸ” é»˜è®¤è´¦å·ï¼šadmin"
  echo "ğŸ” é»˜è®¤å¯†ç ï¼šumami"
  echo "ï¼ˆé¦–æ¬¡å¯åŠ¨è‡ªåŠ¨åˆ›å»ºï¼‰"
  echo

  pause
}

###############################################
# æ›´æ–°
###############################################
update_umami() {
  print_header

  if [[ ! -f "$COMPOSE_FILE" ]]; then
    echo "âŒ æœªæ£€æµ‹åˆ°å®‰è£…ç›®å½•ï¼š$UMAMI_DIR"
    pause
    return
  fi

  echo "â¬†ï¸ æ­£åœ¨æ›´æ–° Umami é•œåƒ..."
  cd "$UMAMI_DIR"
  docker compose pull
  docker compose up -d --force-recreate

  echo
  echo "âœ… æ›´æ–°æˆåŠŸï¼"
  pause
}

###############################################
# å¸è½½
###############################################
uninstall_umami() {
  print_header

  echo "âš ï¸ å¸è½½å°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼"
  read -rp "è¾“å…¥ YES ç¡®è®¤å¸è½½ï¼š" confirm
  [[ "$confirm" != "YES" ]] && echo "âŒ å·²å–æ¶ˆ" && return

  cd "$UMAMI_DIR" || true

  echo "ğŸ›‘ åœæ­¢å®¹å™¨..."
  docker compose down -v || true

  echo "ğŸ—‘ åˆ é™¤ç›®å½•ï¼š$UMAMI_DIR"
  rm -rf "$UMAMI_DIR"

  echo "ğŸ§¾ åˆ é™¤é…ç½®ï¼š$CONFIG_FILE"
  rm -f "$CONFIG_FILE"

  echo "âœ… å¸è½½å®Œæˆï¼"
  pause
}

###############################################
# æ¸…ç†ç¼“å­˜
###############################################
clean_cache() {
  print_header
  echo "ğŸ§¹ æ­£åœ¨æ¸…ç† Docker ç¼“å­˜..."
  docker system prune -f || true
  echo "âœ… å®Œæˆï¼"
  pause
}

###############################################
# ä¸»èœå•
###############################################
main_menu() {
  require_root
  load_or_create_config

  while true; do
    print_header
    echo "è¯·é€‰æ‹©ï¼š"
    echo
    echo "  1) å®‰è£… Umami"
    echo "  2) æ›´æ–° Umami"
    echo "  3) å¸è½½ Umami"
    echo "  4) æ¸…ç†ç¼“å­˜"
    echo "  0) é€€å‡º"
    echo
    read -rp "è¯·è¾“å…¥ç¼–å·ï¼š" op

    case "$op" in
      1) install_umami ;;
      2) update_umami ;;
      3) uninstall_umami ;;
      4) clean_cache ;;
      0) exit 0 ;;
      *) echo "âŒ è¾“å…¥é”™è¯¯" ; sleep 1 ;;
    esac
  done
}

main_menu
