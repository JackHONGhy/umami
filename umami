#!/bin/bash

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
SKYBLUE='\033[0;36m'
PLAIN='\033[0m'

# 默认安装目录
DEFAULT_INSTALL_PATH="/opt/umami"

# 检查是否为 Root 用户
check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}请使用 root 权限运行此脚本！${PLAIN}"
        exit 1
    fi
}

# 检查并安装 Docker
check_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${YELLOW}检测到未安装 Docker，正在为您安装...${PLAIN}"
        curl -fsSL https://get.docker.com | bash
        systemctl enable docker
        systemctl start docker
        echo -e "${GREEN}Docker 安装完成！${PLAIN}"
    else
        echo -e "${GREEN}Docker 已安装。${PLAIN}"
    fi

    if ! docker compose version &> /dev/null; then
        echo -e "${YELLOW}检测到 Docker Compose 插件未安装或版本过旧，尝试安装插件...${PLAIN}"
        apt-get update && apt-get install docker-compose-plugin -y || yum install docker-compose-plugin -y
    fi
}

# 获取公网 IP (用于显示登录信息)
get_public_ip() {
    curl -s https://api.ipify.org
}

# 生成随机 APP_SECRET
generate_secret() {
    openssl rand -hex 32
}

# 安装 Umami
install_umami() {
    check_docker

    echo -e "${SKYBLUE}准备安装 Umami...${PLAIN}"
    read -p "请输入安装路径 (默认: $DEFAULT_INSTALL_PATH): " INSTALL_PATH
    INSTALL_PATH=${INSTALL_PATH:-$DEFAULT_INSTALL_PATH}

    if [ -d "$INSTALL_PATH" ]; then
        echo -e "${RED}目录 $INSTALL_PATH 已存在，请检查是否已安装或更换路径。${PLAIN}"
        return
    fi

    read -p "请输入 Umami 运行端口 (默认: 3000): " UMAMI_PORT
    UMAMI_PORT=${UMAMI_PORT:-3000}

    mkdir -p "$INSTALL_PATH"
    cd "$INSTALL_PATH" || exit

    APP_SECRET=$(generate_secret)

    # 创建 docker-compose.yml
    cat > docker-compose.yml <<EOF
version: '3.8'
services:
  umami:
    image: docker.umami.is/umami-software/umami:latest
    container_name: umami
    network_mode: "bridge"
    environment:
      DATABASE_URL: postgresql://umami:umami@db:5432/umami
      DATABASE_TYPE: postgresql
      APP_SECRET: ${APP_SECRET}
    ports:
      - "${UMAMI_PORT}:3000"
    depends_on:
      db:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "wget --spider http://localhost:3000/api/heartbeat || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5

  db:
    image: postgres:15-alpine
    container_name: umami-db
    network_mode: "bridge"
    environment:
      POSTGRES_DB: umami
      POSTGRES_USER: umami
      POSTGRES_PASSWORD: umami
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U umami -d umami"]
      interval: 5s
      timeout: 5s
      retries: 5
EOF

    echo -e "${YELLOW}正在拉取镜像并启动容器，这可能需要几分钟...${PLAIN}"
    docker compose up -d

    if [ $? -eq 0 ]; then
        PUBLIC_IP=$(get_public_ip)
        echo -e "\n${GREEN}==========================================${PLAIN}"
        echo -e "${GREEN}       Umami 安装成功！${PLAIN}"
        echo -e "${GREEN}==========================================${PLAIN}"
        echo -e "访问地址: ${SKYBLUE}http://${PUBLIC_IP}:${UMAMI_PORT}${PLAIN}"
        echo -e "默认用户: ${SKYBLUE}admin${PLAIN}"
        echo -e "默认密码: ${SKYBLUE}umami${PLAIN}"
        echo -e "${YELLOW}请登录后立即修改默认密码！${PLAIN}"
        echo -e "${GREEN}==========================================${PLAIN}"
    else
        echo -e "${RED}安装失败，请检查 Docker 日志。${PLAIN}"
    fi
}

# 更新 Umami
update_umami() {
    echo -e "${SKYBLUE}准备更新 Umami...${PLAIN}"
    read -p "请输入安装路径 (默认: $DEFAULT_INSTALL_PATH): " INSTALL_PATH
    INSTALL_PATH=${INSTALL_PATH:-$DEFAULT_INSTALL_PATH}

    if [ ! -d "$INSTALL_PATH" ]; then
        echo -e "${RED}目录 $INSTALL_PATH 不存在，请检查路径。${PLAIN}"
        return
    fi

    cd "$INSTALL_PATH" || exit
    
    echo -e "${YELLOW}正在拉取最新镜像...${PLAIN}"
    docker compose pull

    echo -e "${YELLOW}正在重新创建容器...${PLAIN}"
    docker compose up -d --remove-orphans

    echo -e "${YELLOW}正在清理旧镜像...${PLAIN}"
    docker image prune -f

    echo -e "${GREEN}Umami 更新完成！${PLAIN}"
}

# 卸载 Umami
uninstall_umami() {
    echo -e "${RED}警告：卸载操作将删除容器！${PLAIN}"
    read -p "请输入安装路径 (默认: $DEFAULT_INSTALL_PATH): " INSTALL_PATH
    INSTALL_PATH=${INSTALL_PATH:-$DEFAULT_INSTALL_PATH}

    if [ ! -d "$INSTALL_PATH" ]; then
        echo -e "${RED}目录 $INSTALL_PATH 不存在，请检查路径。${PLAIN}"
        return
    fi

    cd "$INSTALL_PATH" || exit

    echo -e "${YELLOW}正在停止并移除容器...${PLAIN}"
    docker compose down

    read -p "是否删除数据库数据文件？(y/n): " DELETE_DATA
    if [[ "$DELETE_DATA" == "y" || "$DELETE_DATA" == "Y" ]]; then
        cd ..
        rm -rf "$INSTALL_PATH"
        echo -e "${GREEN}数据文件已删除。${PLAIN}"
    else
        echo -e "${YELLOW}数据文件保留在 $INSTALL_PATH 目录中。${PLAIN}"
    fi

    echo -e "${GREEN}Umami 卸载完成。${PLAIN}"
}

# 主菜单
show_menu() {
    clear
    echo -e "${GREEN}==========================================${PLAIN}"
    echo -e "${GREEN}       Umami 一键管理脚本${PLAIN}"
    echo -e "${GREEN}==========================================${PLAIN}"
    echo -e "${SKYBLUE}1.${PLAIN} 安装 Umami"
    echo -e "${SKYBLUE}2.${PLAIN} 更新 Umami"
    echo -e "${SKYBLUE}3.${PLAIN} 卸载 Umami"
    echo -e "${SKYBLUE}0.${PLAIN} 退出脚本"
    echo -e "${GREEN}==========================================${PLAIN}"
    read -p "请输入选项 [0-3]: " choice

    case $choice in
        1)
            install_umami
            ;;
        2)
            update_umami
            ;;
        3)
            uninstall_umami
            ;;
        0)
            exit 0
            ;;
        *)
            echo -e "${RED}无效选项，请重新输入。${PLAIN}"
            sleep 2
            show_menu
            ;;
    esac
}

# 运行主逻辑
check_root
show_menu
