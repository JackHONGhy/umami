#!/bin/bash

# ==================================================
# Umami ä¸€é”®å®‰è£…/æ›´æ–°ç®¡ç†è„šæœ¬ (ä¿®å¤ç‰ˆ)
# ==================================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®å‚æ•°
INSTALL_DIR="/opt/umami"
UMAMI_IMAGE="docker.umami.is/umami-software/umami:latest"

# å¼ºåˆ¶ä½¿ç”¨ bash è¿è¡Œ
if [ -z "$BASH_VERSION" ]; then
    exec /bin/bash "$0" "$@"
fi

# æ£€æŸ¥ Root æƒé™
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}é”™è¯¯ï¼šè¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬ (sudo ./umami_manager.sh)${NC}"
  exit 1
fi

# æ£€æŸ¥ Docker
check_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}é”™è¯¯ï¼šæœªæ£€æµ‹åˆ° Dockerï¼è¯·å…ˆå®‰è£… Dockerã€‚${NC}"
        exit 1
    fi
}

# æ¸…ç†åžƒåœ¾æ–‡ä»¶
cleanup_junk() {
    echo -e "${BLUE}ðŸ§¹ æ­£åœ¨æ‰§è¡Œè‡ªåŠ¨æ¸…ç†...${NC}"
    docker image prune -f > /dev/null 2>&1
    if [ -f /etc/debian_version ]; then
        apt-get autoremove -y > /dev/null 2>&1
        apt-get clean > /dev/null 2>&1
    elif [ -f /etc/redhat-release ]; then
        yum autoremove -y > /dev/null 2>&1
        yum clean all > /dev/null 2>&1
    fi
    echo -e "${GREEN}âœ” æ¸…ç†å®Œæˆï¼${NC}"
}

# å®‰è£…å‡½æ•°
install_umami() {
    echo -e "${CYAN}=== å¼€å§‹å®‰è£… Umami ===${NC}"
    if [ -d "$INSTALL_DIR" ]; then
        echo -e "${RED}ç›®å½• $INSTALL_DIR å·²å­˜åœ¨ï¼è¯·å…ˆåˆ é™¤æˆ–é€‰æ‹©æ›´æ–°ã€‚${NC}"
        return
    fi

    mkdir -p "$INSTALL_DIR"
    cd "$INSTALL_DIR"

    echo -e "${YELLOW}ç”Ÿæˆé…ç½®æ–‡ä»¶...${NC}"
    DB_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9')
    APP_SECRET=$(openssl rand -hex 32)

    cat > .env <<EOF
DATABASE_URL=postgresql://umami:${DB_PASSWORD}@db:5432/umami
APP_SECRET=${APP_SECRET}
POSTGRES_DB=umami
POSTGRES_USER=umami
POSTGRES_PASSWORD=${DB_PASSWORD}
EOF

    cat > docker-compose.yml <<EOF
version: '3'
services:
  umami:
    image: ${UMAMI_IMAGE}
    network_mode: "bridge"
    environment:
      - DATABASE_URL=\${DATABASE_URL}
      - APP_SECRET=\${APP_SECRET}
    restart: always
    ports:
      - "3000:3000"
    depends_on:
      - db
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/heartbeat || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
  db:
    image: postgres:15-alpine
    network_mode: "bridge"
    environment:
      - POSTGRES_DB=\${POSTGRES_DB}
      - POSTGRES_USER=\${POSTGRES_USER}
      - POSTGRES_PASSWORD=\${POSTGRES_PASSWORD}
    volumes:
      - ./umami-db-data:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \${POSTGRES_USER} -d \${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
EOF

    echo -e "${YELLOW}å¯åŠ¨å®¹å™¨...${NC}"
    docker compose up -d
    IP=$(curl -s ifconfig.me)
    cleanup_junk
    echo -e "\n${GREEN}Umami å®‰è£…æˆåŠŸï¼è®¿é—®: http://${IP}:3000 (admin/umami)${NC}"
}

# æ›´æ–°å‡½æ•°
update_umami() {
    echo -e "${CYAN}=== å¼€å§‹æ›´æ–° Umami ===${NC}"
    if [ ! -d "$INSTALL_DIR" ]; then
        echo -e "${RED}æœªæ‰¾åˆ°å®‰è£…ç›®å½•ï¼Œæ— æ³•æ›´æ–°ã€‚${NC}"
        return
    fi
    cd "$INSTALL_DIR"
    docker compose pull
    docker compose up -d --remove-orphans
    cleanup_junk
    echo -e "\n${GREEN}âœ” æ›´æ–°å®Œæˆï¼${NC}"
}

# ä¸»èœå• (ä¿®å¤è¾“å…¥è¯»å–é—®é¢˜)
show_menu() {
    clear
    echo -e "${BLUE}#############################################${NC}"
    echo -e "${BLUE}#           Umami ç®¡ç†è„šæœ¬ (ä¿®å¤ç‰ˆ)         #${NC}"
    echo -e "${BLUE}#############################################${NC}"
    echo -e "  ${GREEN}1.${NC} å®‰è£… Umami"
    echo -e "  ${GREEN}2.${NC} æ›´æ–° Umami"
    echo -e "  ${RED}0.${NC} é€€å‡º"
    echo -e "---------------------------------------------"
    
    # å¼ºåˆ¶ä»Ž tty è¯»å–è¾“å…¥ï¼Œé˜²æ­¢æ­»å¾ªçŽ¯
    if [ -t 0 ]; then
        read -p "è¯·è¾“å…¥é€‰é¡¹ [0-2]: " choice
    else
        read -p "è¯·è¾“å…¥é€‰é¡¹ [0-2]: " choice < /dev/tty
    fi

    case $choice in
        1) install_umami; read -p "æŒ‰å›žè½¦ç»§ç»­..." ;;
        2) update_umami; read -p "æŒ‰å›žè½¦ç»§ç»­..." ;;
        0) exit 0 ;;
        *) echo -e "${RED}æ— æ•ˆé€‰é¡¹${NC}"; sleep 1 ;;
    esac
}

while true; do
    show_menu
done
