#!/bin/bash

# ==================================================
# Umami ä¸€é”®å®‰è£…/æ›´æ–°ç®¡ç†è„šæœ¬ (Docker Composeç‰ˆ)
# ==================================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®å‚æ•°
INSTALL_DIR="/opt/umami"
UMAMI_IMAGE="docker.umami.is/umami-software/umami:latest"

# æ£€æŸ¥ Root æƒé™
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}é”™è¯¯ï¼šè¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬ (sudo ./umami_manager.sh)${NC}"
  exit 1
fi

# æ£€æŸ¥ Docker æ˜¯å¦å­˜åœ¨ (ä»…æ£€æŸ¥ï¼Œä¸å®‰è£…)
check_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}é”™è¯¯ï¼šæœªæ£€æµ‹åˆ° Dockerï¼${NC}"
        echo -e "è¯·å…ˆè‡ªè¡Œå®‰è£… Docker å’Œ Docker Compose åŽå†è¿è¡Œæ­¤è„šæœ¬ã€‚"
        exit 1
    fi
}

# æ¸…ç†åžƒåœ¾æ–‡ä»¶å‡½æ•°
cleanup_junk() {
    echo -e "${BLUE}ðŸ§¹ æ­£åœ¨æ‰§è¡Œè‡ªåŠ¨æ¸…ç†...${NC}"
    
    # 1. æ¸…ç† Docker æ— ç”¨é•œåƒ (Dangling images)
    docker image prune -f > /dev/null 2>&1
    
    # 2. æ ¹æ®ç³»ç»Ÿæ¸…ç†åŒ…ç®¡ç†å™¨ç¼“å­˜
    if [ -f /etc/debian_version ]; then
        # Debian/Ubuntu
        apt-get autoremove -y > /dev/null 2>&1
        apt-get clean > /dev/null 2>&1
    elif [ -f /etc/redhat-release ]; then
        # CentOS/RHEL
        yum autoremove -y > /dev/null 2>&1
        yum clean all > /dev/null 2>&1
    fi
    
    echo -e "${GREEN}âœ” æ¸…ç†å®Œæˆï¼${NC}"
}

# å®‰è£…å‡½æ•°
install_umami() {
    echo -e "${CYAN}=== å¼€å§‹å®‰è£… Umami ===${NC}"

    if [ -d "$INSTALL_DIR" ]; then
        echo -e "${RED}æ£€æµ‹åˆ°ç›®å½• $INSTALL_DIR å·²å­˜åœ¨ï¼${NC}"
        echo -e "å¦‚æžœéœ€è¦é‡æ–°å®‰è£…ï¼Œè¯·å…ˆåˆ é™¤è¯¥ç›®å½•ï¼Œæˆ–è€…é€‰æ‹© [2] æ›´æ–°ã€‚"
        read -p "æŒ‰å›žè½¦é”®è¿”å›žä¸»èœå•..."
        return
    fi

    mkdir -p "$INSTALL_DIR"
    cd "$INSTALL_DIR"

    # ç”Ÿæˆéšæœºå¯†ç 
    echo -e "${YELLOW}ç”Ÿæˆå®‰å…¨å¯†é’¥ä¸­...${NC}"
    DB_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9')
    APP_SECRET=$(openssl rand -hex 32)

    # åˆ›å»º .env
    cat > .env <<EOF
DATABASE_URL=postgresql://umami:${DB_PASSWORD}@db:5432/umami
APP_SECRET=${APP_SECRET}
POSTGRES_DB=umami
POSTGRES_USER=umami
POSTGRES_PASSWORD=${DB_PASSWORD}
EOF

    # åˆ›å»º docker-compose.yml
    cat > docker-compose.yml <<EOF
version: '3'
services:
  umami:
    image: ${UMAMI_IMAGE}
    network_mode: "bridge"
    environment:
      - DATABASE_URL=\${DATABASE_URL}
      - APP_SECRET=\${APP_SECRET}
    restart: always
    ports:
      - "3000:3000"
    depends_on:
      - db
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/heartbeat || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  db:
    image: postgres:15-alpine
    network_mode: "bridge"
    environment:
      - POSTGRES_DB=\${POSTGRES_DB}
      - POSTGRES_USER=\${POSTGRES_USER}
      - POSTGRES_PASSWORD=\${POSTGRES_PASSWORD}
    volumes:
      - ./umami-db-data:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \${POSTGRES_USER} -d \${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
EOF

    echo -e "${YELLOW}æ­£åœ¨å¯åŠ¨å®¹å™¨...${NC}"
    docker compose up -d

    IP=$(curl -s ifconfig.me)
    
    # æ‰§è¡Œæ¸…ç†
    cleanup_junk

    echo -e "\n${GREEN}======================================${NC}"
    echo -e "${GREEN}      Umami å®‰è£…æˆåŠŸï¼      ${NC}"
    echo -e "${GREEN}======================================${NC}"
    echo -e "è®¿é—®åœ°å€: ${CYAN}http://${IP}:3000${NC}"
    echo -e "é»˜è®¤ç”¨æˆ·: ${YELLOW}admin${NC}"
    echo -e "é»˜è®¤å¯†ç : ${YELLOW}umami${NC}"
    echo -e "é…ç½®æ–‡ä»¶: ${INSTALL_DIR}"
    echo -e "æ•°æ®åº“å¯†ç å·²ä¿å­˜è‡³ .env æ–‡ä»¶"
    echo -e "--------------------------------------"
    read -p "æŒ‰å›žè½¦é”®è¿”å›žä¸»èœå•..."
}

# æ›´æ–°å‡½æ•°
update_umami() {
    echo -e "${CYAN}=== å¼€å§‹æ›´æ–° Umami ===${NC}"
    
    if [ ! -d "$INSTALL_DIR" ]; then
        echo -e "${RED}é”™è¯¯ï¼šæœªæ‰¾åˆ°å®‰è£…ç›®å½• $INSTALL_DIR${NC}"
        echo -e "è¯·å…ˆæ‰§è¡Œå®‰è£…ã€‚"
        read -p "æŒ‰å›žè½¦é”®è¿”å›žä¸»èœå•..."
        return
    fi

    cd "$INSTALL_DIR"
    
    echo -e "${YELLOW}æ­£åœ¨æ‹‰å–æœ€æ–°é•œåƒ...${NC}"
    docker compose pull

    echo -e "${YELLOW}æ­£åœ¨é‡å»ºå®¹å™¨...${NC}"
    docker compose up -d --remove-orphans

    # æ‰§è¡Œæ¸…ç†
    cleanup_junk

    echo -e "\n${GREEN}âœ” Umami æ›´æ–°å®Œæˆï¼${NC}"
    read -p "æŒ‰å›žè½¦é”®è¿”å›žä¸»èœå•..."
}

# ä¸»èœå•
show_menu() {
    clear
    echo -e "${BLUE}#############################################${NC}"
    echo -e "${BLUE}#           Umami ç®¡ç†è„šæœ¬ (Docker)         #${NC}"
    echo -e "${BLUE}#############################################${NC}"
    echo -e ""
    echo -e "  ${GREEN}1.${NC} å®‰è£… Umami (Install)"
    echo -e "  ${GREEN}2.${NC} æ›´æ–° Umami (Update)"
    echo -e "  ${RED}0.${NC} é€€å‡ºè„šæœ¬ (Exit)"
    echo -e ""
    echo -e "---------------------------------------------"
    check_docker
    echo -e "DockerçŠ¶æ€: ${GREEN}å·²å®‰è£…${NC}"
    echo -e "---------------------------------------------"
    read -p "è¯·è¾“å…¥é€‰é¡¹ [0-2]: " choice

    case $choice in
        1)
            install_umami
            ;;
        2)
            update_umami
            ;;
        0)
            echo -e "é€€å‡ºè„šæœ¬ã€‚"
            exit 0
            ;;
        *)
            echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚${NC}"
            sleep 1
            ;;
    esac
}

# å¾ªçŽ¯æ˜¾ç¤ºèœå•
while true; do
    show_menu
done
