#!/bin/bash

# ==================================================
# Umami 一键全能脚本 (IPv4优先 & 卸载功能)
# ==================================================

# 颜色定义
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 配置路径
INSTALL_DIR="/opt/umami"
UMAMI_IMAGE="docker.umami.is/umami-software/umami:latest"

# 检查 Root 权限
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}请使用 root 权限运行此脚本${NC}"
  exit 1
fi

# 1. 检查 Docker
check_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}错误：未检测到 Docker，请先安装 Docker。${NC}"
        exit 1
    fi
}

# 2. 强制获取 IPv4 地址
get_ipv4() {
    # 尝试方式1: ifconfig.me (强制IPv4)
    IP=$(curl -s -4 ifconfig.me)
    
    # 尝试方式2: icanhazip.com (如果方式1失败)
    if [ -z "$IP" ]; then
        IP=$(curl -s -4 icanhazip.com)
    fi

    # 尝试方式3: 本机内网IP (如果外网获取失败)
    if [ -z "$IP" ]; then
        IP=$(hostname -I | awk '{print $1}')
    fi
}

# 3. 清理垃圾
cleanup_junk() {
    echo "正在清理系统缓存..."
    docker image prune -f > /dev/null 2>&1
    if [ -f /etc/debian_version ]; then
        apt-get autoremove -y > /dev/null 2>&1
        apt-get clean > /dev/null 2>&1
    elif [ -f /etc/redhat-release ]; then
        yum autoremove -y > /dev/null 2>&1
        yum clean all > /dev/null 2>&1
    fi
}

# 4. 安装流程
install_umami() {
    if [ -d "$INSTALL_DIR" ]; then
        echo -e "${YELLOW}目录已存在，请选择更新或卸载。${NC}"
        wait_input
        return
    fi

    mkdir -p "$INSTALL_DIR"
    cd "$INSTALL_DIR"

    # 生成密码
    DB_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9')
    APP_SECRET=$(openssl rand -hex 32)

    # 写入配置文件
    cat > .env <<EOF
DATABASE_URL=postgresql://umami:${DB_PASSWORD}@db:5432/umami
APP_SECRET=${APP_SECRET}
POSTGRES_DB=umami
POSTGRES_USER=umami
POSTGRES_PASSWORD=${DB_PASSWORD}
EOF

    cat > docker-compose.yml <<EOF
version: '3'
services:
  umami:
    image: ${UMAMI_IMAGE}
    network_mode: "bridge"
    environment:
      - DATABASE_URL=\${DATABASE_URL}
      - APP_SECRET=\${APP_SECRET}
    restart: always
    ports:
      - "3000:3000"
    depends_on:
      - db
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/heartbeat || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  db:
    image: postgres:15-alpine
    network_mode: "bridge"
    environment:
      - POSTGRES_DB=\${POSTGRES_DB}
      - POSTGRES_USER=\${POSTGRES_USER}
      - POSTGRES_PASSWORD=\${POSTGRES_PASSWORD}
    volumes:
      - ./umami-db-data:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \${POSTGRES_USER} -d \${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
EOF

    echo "正在启动容器..."
    docker compose up -d > /dev/null 2>&1
    cleanup_junk
    get_ipv4

    # === 成功界面 ===
    clear
    echo "已经安装完成"
    echo "------------------------------------------------"
    echo "访问地址："
    echo "http://${IP}:3000"
    echo "初始用户名：admin"
    echo "初始密码：umami"
    echo -e "${GREEN}操作完成${NC}"
    echo "------------------------------------------------"
    echo "如果无法访问，请务必检查服务器防火墙是否放行 3000 端口"
    wait_input
}

# 5. 更新流程
update_umami() {
    if [ ! -d "$INSTALL_DIR" ]; then
        echo -e "${RED}未安装 Umami，无法更新。${NC}"
        wait_input
        return
    fi
    cd "$INSTALL_DIR"
    echo "正在拉取新镜像..."
    docker compose pull > /dev/null 2>&1
    docker compose up -d --remove-orphans > /dev/null 2>&1
    cleanup_junk
    echo -e "${GREEN}更新操作完成${NC}"
    wait_input
}

# 6. 卸载流程
uninstall_umami() {
    if [ ! -d "$INSTALL_DIR" ]; then
        echo -e "${RED}未找到安装目录，无需卸载。${NC}"
        wait_input
        return
    fi

    echo -e "${RED}警告：此操作将删除所有 Umami 数据且无法恢复！${NC}"
    read -p "确认要卸载吗？(输入 y 确认): " confirm < /dev/tty
    
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        cd "$INSTALL_DIR"
        echo "正在停止服务..."
        docker compose down -v > /dev/null 2>&1
        cd ..
        rm -rf "$INSTALL_DIR"
        echo "正在清理残余镜像..."
        cleanup_junk
        echo -e "${GREEN}卸载操作完成${NC}"
    else
        echo "操作已取消"
    fi
    wait_input
}

# 等待按键
wait_input() {
    echo ""
    read -n 1 -s -r -p "按任意键继续..." < /dev/tty
}

# 主菜单
show_menu() {
    clear
    echo "========================="
    echo "   Umami 管理脚本 V2.0"
    echo "========================="
    echo "1. 安装 Umami"
    echo "2. 更新 Umami"
    echo "3. 卸载 Umami"
    echo "0. 退出"
    echo "-------------------------"
    read -p "请输入选项: " choice < /dev/tty

    case $choice in
        1) install_umami ;;
        2) update_umami ;;
        3) uninstall_umami ;;
        0) exit 0 ;;
        *) echo "无效选项"; sleep 1 ;;
    esac
}

check_docker
while true; do
    show_menu
done
