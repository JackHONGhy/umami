#!/bin/bash

# ==================================================
# Umami 一键安装脚本 (仿图版 & 修复输入问题)
# ==================================================

# 颜色定义
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# 配置路径
INSTALL_DIR="/opt/umami"
UMAMI_IMAGE="docker.umami.is/umami-software/umami:latest"

# 检查是否为 Root
if [ "$EUID" -ne 0 ]; then
  echo "请使用 root 权限运行此脚本"
  exit 1
fi

# 1. 检查 Docker (不安装，仅检查)
check_docker() {
    if ! command -v docker &> /dev/null; then
        echo "错误：未检测到 Docker，请先安装 Docker 和 Docker Compose。"
        exit 1
    fi
}

# 2. 清理垃圾文件
cleanup_junk() {
    echo "正在清理缓存..."
    # 清理 Docker 悬空镜像
    docker image prune -f > /dev/null 2>&1
    
    # 系统清理
    if [ -f /etc/debian_version ]; then
        apt-get autoremove -y > /dev/null 2>&1
        apt-get clean > /dev/null 2>&1
    elif [ -f /etc/redhat-release ]; then
        yum autoremove -y > /dev/null 2>&1
        yum clean all > /dev/null 2>&1
    fi
}

# 3. 获取 IP 地址
get_ip() {
    # 尝试获取外网IP，如果失败则获取内网IP
    IP=$(curl -s ifconfig.me)
    if [ -z "$IP" ]; then
        IP=$(hostname -I | awk '{print $1}')
    fi
}

# 4. 安装流程
install_umami() {
    if [ -d "$INSTALL_DIR" ]; then
        echo "目录 $INSTALL_DIR 已存在，请先选择更新或手动删除。"
        wait_input
        return
    fi

    mkdir -p "$INSTALL_DIR"
    cd "$INSTALL_DIR"

    # 生成随机密码
    DB_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9')
    APP_SECRET=$(openssl rand -hex 32)

    # 创建 .env
    cat > .env <<EOF
DATABASE_URL=postgresql://umami:${DB_PASSWORD}@db:5432/umami
APP_SECRET=${APP_SECRET}
POSTGRES_DB=umami
POSTGRES_USER=umami
POSTGRES_PASSWORD=${DB_PASSWORD}
EOF

    # 创建 docker-compose.yml
    cat > docker-compose.yml <<EOF
version: '3'
services:
  umami:
    image: ${UMAMI_IMAGE}
    network_mode: "bridge"
    environment:
      - DATABASE_URL=\${DATABASE_URL}
      - APP_SECRET=\${APP_SECRET}
    restart: always
    ports:
      - "3000:3000"
    depends_on:
      - db
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/heartbeat || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  db:
    image: postgres:15-alpine
    network_mode: "bridge"
    environment:
      - POSTGRES_DB=\${POSTGRES_DB}
      - POSTGRES_USER=\${POSTGRES_USER}
      - POSTGRES_PASSWORD=\${POSTGRES_PASSWORD}
    volumes:
      - ./umami-db-data:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \${POSTGRES_USER} -d \${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
EOF

    # 启动
    docker compose up -d > /dev/null 2>&1
    
    # 清理
    cleanup_junk
    
    # 获取IP
    get_ip

    # === 输出样式复刻图片 ===
    clear
    echo "已经安装完成"
    echo "------------------------------------------------"
    echo "访问地址："
    echo "http://${IP}:3000"
    echo "初始用户名：admin"
    echo "初始密码：umami"
    echo -e "${GREEN}操作完成${NC}"
    wait_input
}

# 5. 更新流程
update_umami() {
    if [ ! -d "$INSTALL_DIR" ]; then
        echo "未找到安装目录，无法更新。"
        wait_input
        return
    fi
    cd "$INSTALL_DIR"
    echo "正在拉取最新镜像..."
    docker compose pull > /dev/null 2>&1
    echo "正在重建容器..."
    docker compose up -d --remove-orphans > /dev/null 2>&1
    cleanup_junk
    
    echo -e "${GREEN}更新操作完成${NC}"
    wait_input
}

# 等待按键 (修复跳过问题)
wait_input() {
    read -n 1 -s -r -p "按任意键继续..." < /dev/tty
}

# 主菜单
show_menu() {
    clear
    echo "========================="
    echo "   Umami 管理脚本"
    echo "========================="
    echo "1. 安装 Umami"
    echo "2. 更新 Umami"
    echo "0. 退出"
    echo "-------------------------"
    
    # 强制从 tty 读取，防止死循环
    read -p "请输入选项: " choice < /dev/tty

    case $choice in
        1) install_umami ;;
        2) update_umami ;;
        0) exit 0 ;;
        *) echo "无效选项"; sleep 1 ;;
    esac
}

# 运行检查
check_docker

# 循环菜单
while true; do
    show_menu
done
